/*
 * ATTENTION: The "eval" devtool has been used (maybe by default in mode: "development").
 * This devtool is neither made for production nor for readable output files.
 * It uses "eval()" calls to create a separate source file in the browser devtools.
 * If you are trying to read the output file, select a different devtool (https://webpack.js.org/configuration/devtool/)
 * or disable the default devtool with "devtool: false".
 * If you are looking for production-ready output files, see mode: "production" (https://webpack.js.org/configuration/mode/).
 */
/******/ (() => { // webpackBootstrap
/******/ 	var __webpack_modules__ = ({

/***/ "./src/index.js":
/*!**********************!*\
  !*** ./src/index.js ***!
  \**********************/
/***/ (() => {

eval("const CONVERSATION_UUID_KEY = 'conversation_uuid';\nlet conversationUuid = localStorage.getItem(CONVERSATION_UUID_KEY);\nlet API_BASE_URL = '';\nlet socket = null; // WebSocket连接\n\nasync function createNewConversation() {\n    try {\n        const response = await fetch(API_BASE_URL + '/api/v1/chat', {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/json'\n            }\n        });\n        if (!response.ok) {\n            throw new Error(`HTTP error! status: ${response.status}`);\n        }\n        const data = await response.json();\n        if (data.code === 200 && data.data && data.data.uuid) {\n            localStorage.setItem(CONVERSATION_UUID_KEY, data.data.uuid);\n            return data.data.uuid;\n        } else {\n            console.error('Failed to create conversation:', data.msg);\n            return null;\n        }\n    } catch (error) {\n        console.error('Error creating conversation:', error);\n        return null;\n    }\n}\n\nasync function getMessages(uuid) {\n    try {\n        // 后端现在默认返回最新的消息，不再需要分页参数\n        const response = await fetch(`${API_BASE_URL}/api/v1/chat/${uuid}/messages`);\n        if (!response.ok) {\n            throw new Error(`HTTP error! status: ${response.status}`);\n        }\n        const data = await response.json();\n        if (data.code === 200 && data.data && data.data.items) {\n            return data.data.items;\n        } else {\n            console.error('Failed to get messages:', data.msg);\n            return [];\n        }\n    } catch (error) {\n        console.error('Error getting messages:', error);\n        return [];\n    }\n}\n\nasync function sendMessage(uuid, content) {\n    try {\n        const sender = \"customer\";\n        const response = await fetch(`${API_BASE_URL}/api/v1/chat/messages`, {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/json'\n            },\n            body: JSON.stringify({ uuid, content, sender })\n        });\n        if (!response.ok) {\n            throw new Error(`HTTP error! status: ${response.status}`);\n        }\n        const data = await response.json();\n        if (data.code === 200 && data.data) {\n            return data.data;\n        } else {\n            console.error('Failed to send message:', data.msg);\n            return null;\n        }\n    } catch (error) {\n        console.error('Error sending message:', error);\n        return null;\n    }\n}\n\nasync function initializeChatWidget(options) {\n    if (options && options.baseUrl) {\n        API_BASE_URL = options.baseUrl;\n    }\n\n    if (!conversationUuid) {\n        console.log('No conversation UUID found, creating a new one...');\n        conversationUuid = await createNewConversation();\n        if (!conversationUuid) {\n            console.error('Could not initialize chat widget: Failed to create conversation.');\n            return;\n        }\n    }\n    console.log('Conversation UUID:', conversationUuid);\n    \n    // 初始化WebSocket连接\n    initWebSocket();\n\n    // Here you would typically render your chat widget UI\n    // For now, let's just add a simple indicator\n    // Check if the chat container already exists to prevent multiple creations\n    let chatContainer = document.getElementById('chat-widget-container');\n    if (!chatContainer) {\n        chatContainer = document.createElement('div');\n        chatContainer.id = 'chat-widget-container';\n        chatContainer.style.position = 'fixed';\n        chatContainer.style.bottom = '20px';\n        chatContainer.style.right = '20px';\n        chatContainer.style.width = '320px';\n        chatContainer.style.height = '450px';\n        chatContainer.style.backgroundColor = '#ffffff';\n        chatContainer.style.border = 'none';\n        chatContainer.style.borderRadius = '12px';\n        chatContainer.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';\n        chatContainer.style.zIndex = '1000';\n        chatContainer.style.display = 'flex';\n        chatContainer.style.flexDirection = 'column';\n        chatContainer.style.overflow = 'hidden';\n        chatContainer.style.fontFamily = 'Arial, sans-serif';\n        document.body.appendChild(chatContainer);\n\n        // Add a button to toggle chat visibility\n        const toggleButton = document.createElement('button');\n        toggleButton.innerText = '💬';\n        toggleButton.style.position = 'fixed';\n        toggleButton.style.bottom = '30px';\n        toggleButton.style.right = '30px';\n        toggleButton.style.width = '60px';\n        toggleButton.style.height = '60px';\n        toggleButton.style.borderRadius = '50%';\n        toggleButton.style.backgroundColor = '#007bff';\n        toggleButton.style.color = 'white';\n        toggleButton.style.fontSize = '24px';\n        toggleButton.style.border = 'none';\n        toggleButton.style.boxShadow = '0 4px 10px rgba(0,0,0,0.2)';\n        toggleButton.style.cursor = 'pointer';\n        toggleButton.style.zIndex = '1001';\n        toggleButton.onclick = () => {\n            chatContainer.style.display = 'flex';\n            toggleButton.style.display = 'none';\n            messagesContainer.scrollTop = messagesContainer.scrollHeight;\n        };\n        document.body.appendChild(toggleButton);\n\n        // Initially hide the chat window\n        chatContainer.style.display = 'none';\n        toggleButton.innerText = 'Open Chat';\n    }\n\n    chatContainer.innerHTML = `\n        <div style=\"padding: 15px; background-color: #007bff; color: white; border-bottom: 1px solid #0056b3; font-weight: bold; text-align: center; font-size: 16px; position: relative;\">\n            Support Chat\n            <button id=\"close-button\" style=\"position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: none; border: none; color: white; font-size: 20px; cursor: pointer;\">&times;</button>\n        </div>\n        <div id=\"messages-container\" style=\"flex-grow: 1; padding: 15px; overflow-y: auto; background-color: #f8f9fa;\"></div>\n        <div style=\"padding: 15px; border-top: 1px solid #e9ecef; display: flex; align-items: center; background-color: #f0f2f5;\">\n            <input type=\"text\" id=\"message-input\" style=\"flex-grow: 1; padding: 10px; border: 1px solid #ced4da; border-radius: 20px; font-size: 14px; outline: none;\" placeholder=\"Type your message...\">\n            <button id=\"send-button\" style=\"margin-left: 10px; padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 14px; transition: background-color 0.2s;\">Send</button>\n        </div>\n    `;\n\n    const messagesContainer = chatContainer.querySelector('#messages-container');\n    const messageInput = chatContainer.querySelector('#message-input');\n    const sendButton = chatContainer.querySelector('#send-button');\n    const closeButton = chatContainer.querySelector('#close-button');\n\n    closeButton.onclick = () => {\n        chatContainer.style.display = 'none';\n        toggleButton.style.display = 'block';\n    };\n\n    function addMessageToChat(message) {\n        const messageElement = document.createElement('div');\n        messageElement.style.marginBottom = '10px';\n        messageElement.style.display = 'flex';\n        messageElement.style.justifyContent = message.sender === 'customer' ? 'flex-end' : 'flex-start';\n        messageElement.innerHTML = `\n            <div style=\"background-color: ${message.sender === 'customer' ? '#dcf8c6' : '#e9ecef'}; color: ${message.sender === 'customer' ? '#333' : '#333'}; padding: 10px 15px; border-radius: 18px; max-width: 75%; word-wrap: break-word; box-shadow: 0 1px 1px rgba(0,0,0,0.05);\">\n                ${message.content}\n            </div>\n        `;\n        messagesContainer.appendChild(messageElement);\n        messagesContainer.scrollTop = messagesContainer.scrollHeight;\n    }\n\n    sendButton.onclick = async () => {\n        const content = messageInput.value.trim();\n        if (content && conversationUuid) {\n            // Display user's message immediately\n            addMessageToChat({ content: content, sender: 'customer' });\n            messageInput.value = '';\n            const sentMessage = await sendMessage(conversationUuid, content);\n            // if (sentMessage && sentMessage.content) {\n            //     // Display agent's response\n            //     addMessageToChat({ content: sentMessage.content, sender: 'agent' });\n            // }\n        }\n    };\n\n    messageInput.onkeypress = (e) => {\n        if (e.key === 'Enter') {\n            sendButton.click();\n        }\n    };\n\n    // Load existing messages\n    if (conversationUuid) {\n        const messages = await getMessages(conversationUuid);\n        messages.forEach(msg => {\n            addMessageToChat(msg);\n        });\n        // 确保加载消息后滚动到最底部\n        messagesContainer.scrollTop = messagesContainer.scrollHeight;\n    }\n\n    // 初始化WebSocket连接\n    function initWebSocket() {\n        // 如果已经有连接，先关闭\n        if (socket) {\n            socket.close();\n        }\n\n        // 创建WebSocket连接\n        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';\n        const wsUrl = `${wsProtocol}//${API_BASE_URL.replace(/^https?:\\/\\//, '')}/api/v1/chat/ws?conv_uuid=${conversationUuid}&client_type=customer`;\n        \n        try {\n            socket = new WebSocket(wsUrl);\n            \n            // 连接打开时\n            socket.onopen = () => {\n                console.log('WebSocket连接已建立');\n            };\n            \n            // 接收消息\n            socket.onmessage = (event) => {\n                try {\n                    const message = JSON.parse(event.data);\n                    // 只处理消息类型的数据\n                    if (message.type === 'message') {\n                        // 如果是客服发送的消息，显示在聊天窗口中\n                        if (message.sender === 'agent') {\n                            addMessageToChat({ content: message.content, sender: 'agent' });\n                        }\n                    }\n                } catch (e) {\n                    console.error('解析WebSocket消息失败:', e);\n                }\n            };\n            \n            // 连接关闭\n            socket.onclose = () => {\n                console.log('WebSocket连接已关闭');\n                // 可以在这里添加重连逻辑\n                setTimeout(() => {\n                    if (conversationUuid) {\n                        initWebSocket();\n                    }\n                }, 5000); // 5秒后尝试重连\n            };\n            \n            // 连接错误\n            socket.onerror = (error) => {\n                console.error('WebSocket错误:', error);\n            };\n            \n        } catch (error) {\n            console.error('创建WebSocket连接失败:', error);\n        }\n    }\n\n    // Expose functions globally for external access\n    window.SupportChatWidget = {\n        init: initializeChatWidget,\n        getMessages: getMessages,\n        sendMessage: sendMessage\n    };\n}\n\n// If the script is loaded asynchronously, initialize it when DOM is ready\ndocument.addEventListener('DOMContentLoaded', async () => {\n    // Always initialize the chat widget when DOM is ready\n    initializeChatWidget({ baseUrl: 'http://localhost:8888' });\n\n});\n\n//# sourceURL=webpack://widget/./src/index.js?");

/***/ })

/******/ 	});
/************************************************************************/
/******/ 	
/******/ 	// startup
/******/ 	// Load entry module and return exports
/******/ 	// This entry module can't be inlined because the eval devtool is used.
/******/ 	var __webpack_exports__ = {};
/******/ 	__webpack_modules__["./src/index.js"]();
/******/ 	
/******/ })()
;